<!doctype html><html lang="cs"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Orders Probe</title><style>body{font-family:-apple-system,'SF Pro Text','Segoe UI',Roboto,Helvetica,Arial;margin:0;background:linear-gradient(160deg,#eef5ff,#f7fbff)}.wrap{max-width:1200px;margin:28px auto;padding:16px}.card{backdrop-filter:blur(16px);background:rgba(255,255,255,.6);border:1px solid rgba(255,255,255,.7);border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.12);padding:16px;margin-bottom:12px}label{display:block;margin:10px 0 4px;font-weight:600}input,select{padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.85);outline:none}input[type=text],input[type=date]{width:100%}.row{display:flex;gap:12px;flex-wrap:wrap}.row>*{flex:1 1 180px}button{padding:10px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.08);background:#fff;cursor:pointer;font-weight:600}button.primary{background:#4dabff;color:#fff;border:none}table{width:100%;border-collapse:separate;border-spacing:0 8px}th,td{padding:10px;background:#fff;border:1px solid rgba(0,0,0,.06);vertical-align:top}th{background:#f6f9ff;text-align:left}</style></head><body><div class="wrap"><h2>Orders Probe</h2><div class="card"><div class="row"><div><label>Base URL</label><input id="base" type="text" readonly></div><div><label>API Key</label><input id="key" type="text" readonly></div><div style="display:flex;gap:8px;align-items:flex-end"><button id="ping" class="primary">Ping</button><span id="pingStatus">–</span></div></div><div class="row"><div><label>Stav</label><select id="status"><option value="">(vše)</option><option>pending</option><option>processing</option><option>completed</option><option>cancelled</option><option>refunded</option><option>on-hold</option></select></div><div><label>Od</label><input id="from" type="date"></div><div><label>Do</label><input id="to" type="date"></div><div><label>Počet</label><select id="limit"><option>20</option><option selected>50</option><option>100</option></select></div><div style="display:flex;gap:8px;align-items:flex-end"><button id="load" class="primary">Načíst</button><button id="exportCsv">Export CSV</button><button id="exportJson">Export JSON</button></div></div></div><div class="card"><div id="tableWrap">–</div></div><div class="card"><h3>Debug JSON</h3><textarea id="debug" style="width:100%;min-height:120px"></textarea></div></div><script src="/pbp/tools/telemetry.js"></script><script>const K_CFG="pbp.bridge.config";const $=s=>document.querySelector(s);const base=$("#base"),key=$("#key"),pingBtn=$("#ping"),pingStatus=$("#pingStatus"),statusEl=$("#status"),fromEl=$("#from"),toEl=$("#to"),limitEl=$("#limit"),loadBtn=$("#load"),debugEl=$("#debug"),table=$("#tableWrap"),exportCsvBtn=$("#exportCsv"),exportJsonBtn=$("#exportJson");let last=[];function loadCfg(){try{const raw=localStorage.getItem(K_CFG);if(!raw)return;const c=JSON.parse(raw);base.value=c.baseUrl||"";key.value=c.apiKey||""}catch(e){}}function csvEsc(v){if(v==null)return"";const s=String(v);return/[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s}function exportCSV(rows){const head=["id","number","date","status","total","currency","email","name","items","payment","shipping"];const lines=[head.join(",")];for(const r of rows){lines.push([r.id,r.number,r.date,r.status,r.total,r.currency,r.email,r.name,r.items_count,r.payment_method,r.shipping_method].map(csvEsc).join(","))}const blob=new Blob([lines.join("\n")],{type:"text/csv"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="orders.csv";a.click()}function exportJSON(rows){const blob=new Blob([JSON.stringify(rows,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="orders.json";a.click()}function render(rows){const head=`<table><thead><tr><th>ID</th><th>Číslo</th><th>Datum</th><th>Stav</th><th>Celkem</th><th>Zákazník</th><th>Položky</th><th>Platba</th><th>Doprava</th></tr></thead><tbody>`;const body=rows.map(r=>{const items=(r.items||[]).map(it=>`${it.qty}× ${it.name} (${it.sku||""})`).join("<br>");return `<tr><td>${r.id}</td><td>${r.number||""}</td><td>${r.date||""}</td><td>${r.status||""}</td><td>${r.total!=null?r.total+" "+(r.currency||""):""}</td><td>${r.name||""}<div class=muted>${r.email||""}</div></td><td>${items||""}</td><td>${r.payment_method||""}</td><td>${r.shipping_method||""}</td></tr>`}).join("");table.innerHTML=head+body+"</tbody></table>"}async function ping(){PBPT.log("orders_ping_click");pingStatus.textContent="…";try{const res=await fetch(base.value.replace(/\/$/,"")+"/ping",{headers:{"X-PBP-API-Key":key.value||""}});pingStatus.textContent=res.ok?"OK":"ERR";debugEl.value=await res.text()}catch(e){pingStatus.textContent="ERR";debugEl.value=String(e)}}async function loadOrders(){PBPT.log("orders_load_click",{status:statusEl.value,from:fromEl.value,to:toEl.value});table.textContent="Načítám…";let url=base.value.replace(/\/$/,"")+"/orders?limit="+encodeURIComponent(limitEl.value||"50");if(statusEl.value)url+="&status="+encodeURIComponent(statusEl.value);if(fromEl.value)url+="&from="+encodeURIComponent(fromEl.value);if(toEl.value)url+="&to="+encodeURIComponent(toEl.value);try{const res=await fetch(url,{headers:{"Content-Type":"application/json","X-PBP-API-Key":key.value||""}});const txt=await res.text();debugEl.value=txt;if(!res.ok){table.textContent="HTTP "+res.status;return}let data;try{data=JSON.parse(txt)}catch(e){table.textContent="Neplatný JSON";return}const arr=Array.isArray(data)?data:(Array.isArray(data.items)?data.items:[]);const rows=[];for(const o of arr){const id=o.id??o.order_id??o.ID??null;const number=o.number??o.order_number??String(id||"");const date=o.date??o.date_created??o.order_date??"";const status=o.status??o.post_status??"";const total=o.total??o.total_amount??o.order_total??null;const currency=o.currency??o.ccy??"";const email=(o.billing&&(o.billing.email||o.billing_email))||o.email||"";const name=(o.billing&&((o.billing.first_name||"")+" "+(o.billing.last_name||"")).trim())||o.customer_name||"";const items=Array.isArray(o.line_items)?o.line_items:(Array.isArray(o.items)?o.items:[]);const mapped=items.map(it=>({name:it.name||"",sku:it.sku||"",qty:it.quantity||it.qty||1}));const payment=o.payment_method_title||o.payment_method||"";const shipping=(Array.isArray(o.shipping_lines)&&o.shipping_lines[0]&&(o.shipping_lines[0].method_title||o.shipping_lines[0].method_id))||o.shipping_method||"";rows.push({id,number,date,status,total,currency,email,name,items_count:mapped.length,items:mapped,payment_method:payment,shipping_method:shipping})}last=rows;render(rows)}catch(e){table.textContent="Výjimka";debugEl.value=String(e)}}loadCfg();pingBtn.addEventListener("click",ping);loadBtn.addEventListener("click",loadOrders);exportCsvBtn.addEventListener("click",()=>exportCSV(last));exportJsonBtn.addEventListener("click",()=>exportJSON(last));PBPT.log("orders_probe_open");</script></body></html>